<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kanban Board</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 20px;
        }
        h1 {
            text-align: center;
        }
        .kanban-board {
            display: flex;
            justify-content: space-around;
            padding: 20px 0;
        }
        .column {
            background: white;
            border-radius: 16px;
            padding: 10px;
            width: 300px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            min-height: 300px;
        }
        .task {
            background: #eaeaea;
            margin: 10px 0;
            padding: 10px;
            border-radius: 8px;
            position: relative;
            cursor: move;
        }
        .add-task {
            margin-top: 10px;
            padding: 5px;
            cursor: pointer;
        }
        button {
            margin-left: 5px;
        }
    </style>
</head>
<body>

<h1>TEAM BOARD</h1>
<div class="kanban-board" id="kanban-board"></div>

<script>
    class KanbanBoard {
        constructor() {
            this.projects = [];
            this.loadProjects(); // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ–µ–∫—Ç—ã –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
        }

        async loadProjects() {
            try {
                const response = await fetch('http://localhost:3000/projects');
                if (!response.ok) {
                    throw new Error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–æ–µ–∫—Ç–æ–≤');
                }
                const projects = await response.json();
                this.projects = projects.projects; // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∞–Ω–Ω—ã—Ö
                this.createTemplate(this.projects);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–æ–µ–∫—Ç–æ–≤:', error);
            }
        }

        createTemplate(projects) {
            const kanbanBoard = document.getElementById('kanban-board');
            kanbanBoard.innerHTML = '';

            projects.forEach(project => {
                project.content.forEach(column => {
                    const columnDiv = this.createDomElement({
                        tag: 'div',
                        classList: 'column',
                        parentAppend: kanbanBoard,
                    });

                    const title = this.createDomElement({
                        tag: 'h3',
                        parentAppend: columnDiv,
                        content: column.status,
                    });

                    column.tasks.forEach(task => {
                        this.createTaskElement(columnDiv, task);
                    });

                    // –ó–∞–º–µ–Ω—è–µ–º –∫–Ω–æ–ø–∫—É –Ω–∞ SVG –∏–∫–æ–Ω–∫—É
                    const addTaskIcon = this.createDomElement({
                        tag: 'div',
                        parentAppend: columnDiv,
                        classList: 'add-task-icon',
                    });

                    // –í—Å—Ç–∞–≤–ª—è–µ–º SVG –∫–æ–¥
                    addTaskIcon.innerHTML = `
                <svg width="20" height="20" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <g clip-path="url(#clip0_519_2176)">
                        <path d="M8 15C6.14348 15 4.36301 14.2625 3.05025 12.9497C1.7375 11.637 1 9.85652 1 8C1 6.14348 1.7375 4.36301 3.05025 3.05025C4.36301 1.7375 6.14348 1 8 1C9.85652 1 11.637 1.7375 12.9497 3.05025C14.2625 4.36301 15 6.14348 15 8C15 9.85652 14.2625 11.637 12.9497 12.9497C11.637 14.2625 9.85652 15 8 15ZM8 16C10.1217 16 12.1566 15.1571 13.6569 13.6569C15.1571 12.1566 16 10.1217 16 8C16 5.87827 15.1571 3.84344 13.6569 2.34315C12.1566 0.842855 10.1217 0 8 0C5.87827 0 3.84344 0.842855 2.34315 2.34315C0.842855 3.84344 0 5.87827 0 8C0 10.1217 0.842855 12.1566 2.34315 13.6569C3.84344 15.1571 5.87827 16 8 16Z" fill="black" fill-opacity="0.5"></path>
                        <path d="M8 4C8.13261 4 8.25979 4.05268 8.35355 4.14645C8.44732 4.24021 8.5 4.36739 8.5 4.5V7.5H11.5C11.6326 7.5 11.7598 7.55268 11.8536 7.64645C11.9473 7.74021 12 7.86739 12 8C12 8.13261 11.9473 8.25979 11.8536 8.35355C11.7598 8.44732 11.6326 8.5 11.5 8.5H8.5V11.5C8.5 11.6326 8.44732 11.7598 8.35355 11.8536C8.25979 11.9473 8.13261 12 8 12C7.86739 12 7.74021 11.9473 7.64645 11.8536C7.55268 11.7598 7.5 11.6326 7.5 11.5V8.5H4.5C4.36739 8.5 4.24021 8.44732 4.14645 8.35355C4.05268 8.25979 4 8.13261 4 8C4 7.86739 4.05268 7.74021 4.14645 7.64645C4.24021 7.55268 4.36739 7.5 4.5 7.5H7.5V4.5C7.5 4.36739 7.55268 4.24021 7.64645 4.14645C7.74021 4.05268 7.86739 4 8 4Z" fill="black" fill-opacity="0.5"></path>
                        </g>
                        <defs>
                        <clipPath id="clip0_519_2176">
                        <rect width="16" height="16" fill="white"></rect>
                        </clipPath>
                        </defs>
                        </svg>
            `;

                    addTaskIcon.onclick = () => this.addTask(columnDiv, column);

                    columnDiv.ondragover = (e) => this.allowDrop(e);
                    columnDiv.ondrop = (e) => this.drop(e, column);
                });
            });
        }


        createDomElement({ tag, classList, parentAppend, content }) {
            const element = document.createElement(tag);
            if (classList) element.className = classList;
            if (content) element.innerHTML = content;
            if (parentAppend) parentAppend.appendChild(element);
            return element;
        }

        createTaskElement(columnDiv, task) {
            const taskDiv = this.createDomElement({
                tag: 'div',
                classList: 'task',
                parentAppend: columnDiv,
                content: task.description + (task.assignee ? ` (–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å: ${task.assignee})` : ''),
            });
            taskDiv.draggable = true;
            taskDiv.ondragstart = (e) => this.drag(e, task);
            taskDiv.id = `task-${task.id}`;

            // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —É–¥–∞–ª–µ–Ω–∏—è
            const editButton = this.createDomElement({
                tag: 'button',
                parentAppend: taskDiv,
                content: '‚úèÔ∏è',
            });
            const deleteButton = this.createDomElement({
                tag: 'button',
                parentAppend: taskDiv,
                content: 'üóëÔ∏è',
            });

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —É–¥–∞–ª–µ–Ω–∏—è
            editButton.onclick = () => this.editTask(task);
            deleteButton.onclick = () => this.deleteTask(task);
        }

        drag(event, task) {
            event.dataTransfer.setData('text/plain', JSON.stringify(task));
            event.dataTransfer.effectAllowed = "move";
        }

        allowDrop(event) {
            event.preventDefault();
        }

        drop(event, column) {
            event.preventDefault();
            const taskData = event.dataTransfer.getData('text/plain');
            const task = JSON.parse(taskData);
            this.removeTaskFromColumn(task);
            task.status = column.status;
            column.tasks.push(task);
            this.updateTaskOnServer(task);
            this.createTemplate(this.projects);
        }

        async updateTaskOnServer(task) {
            try {
                const response = await fetch(`http://localhost:3000/tasks/${task.id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(task),
                });
                const updatedTask = await response.json();
                console.log('–ó–∞–¥–∞—á–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞:', updatedTask);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∏:', error);
            }
        }

        removeTaskFromColumn(task) {
            this.projects.forEach(project => {
                project.content.forEach(column => {
                    const index = column.tasks.findIndex(t => t.id === task.id);
                    if (index > -1) {
                        column.tasks.splice(index, 1);
                    }
                });
            });
        }

        async addTask(columnDiv, column) {
            const taskTitle = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏:');
            const assignee = prompt('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è:');
            if (taskTitle) {
                const newTask = {
                    id: Date.now(),
                    description: taskTitle,
                    status: column.status,
                    assignee: assignee || '–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω', // –£–∫–∞–∑—ã–≤–∞–µ–º –∏–º—è –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è
                };

                await this.addTaskToServer(newTask);
                column.tasks.push(newTask);
                this.createTaskElement(columnDiv, newTask);
            }
        }

        async addTaskToServer(newTask) {
            try {
                const response = await fetch('http://localhost:3000/tasks', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(newTask),
                });
                const addedTask = await response.json();
                console.log('–ó–∞–¥–∞—á–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞:', addedTask);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∏:', error);
            }
        }

        // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏
        async editTask(task) {
            const newDescription = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏:', task.description);
            const newAssignee = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–≥–æ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è:', task.assignee);
            if (newDescription && newDescription !== task.description) {
                task.description = newDescription;
            }
            if (newAssignee && newAssignee !== task.assignee) {
                task.assignee = newAssignee;
            }
            await this.updateTaskOnServer(task);
            this.createTemplate(this.projects); // –û–±–Ω–æ–≤–ª—è–µ–º –¥–æ—Å–∫—É –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
        }

        // –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏
        async deleteTask(task) {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É?')) {
                this.removeTaskFromColumn(task);
                await this.deleteTaskFromServer(task.id);
                this.createTemplate(this.projects); // –û–±–Ω–æ–≤–ª—è–µ–º –¥–æ—Å–∫—É –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è
            }
        }

        async deleteTaskFromServer(taskId) {
            try {
                const response = await fetch(`http://localhost:3000/tasks/${taskId}`, {
                    method: 'DELETE',
                });
                const result = await response.json();
                console.log('–ó–∞–¥–∞—á–∞ —É–¥–∞–ª–µ–Ω–∞:', result);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∑–∞–¥–∞—á–∏:', error);
            }
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        new KanbanBoard();
    });
</script>

</body>
</html>
